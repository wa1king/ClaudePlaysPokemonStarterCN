# 宝可梦红版AI代理 - 保存/加载功能使用说明

## 功能概述

保存/加载功能已成功集成到宝可梦红版AI代理中，支持：
- ✅ 自动保存游戏进度和AI记忆
- ✅ 智能加载最新存档
- ✅ 异常退出保护
- ✅ 存档备份机制
- ✅ 命令行参数控制

## 基本使用

### 1. 默认使用（推荐）
```bash
python main.py --steps 50
```
- 自动从最新存档继续游戏
- 每10步自动保存
- 异常退出时自动紧急保存

### 2. 开始新游戏
```bash
python main.py --steps 30 --new-game
```
- 忽略现有存档，从头开始
- 会创建新的存档文件

### 3. 自定义保存设置
```bash
python main.py --steps 100 --save-every 5 --save-dir "./my_saves"
```
- 每5步保存一次
- 保存到指定目录

### 4. 禁用自动保存
```bash
python main.py --steps 20 --no-auto-save
```
- 关闭自动保存功能
- 仅在异常退出时保存

### 5. 从备份恢复
```bash
python main.py --load-backup --steps 20
```
- 从最新的备份存档恢复
- 用于主存档损坏时

### 6. 查看存档信息
```bash
python main.py --save-info
```
- 显示当前存档的详细信息
- 包括步数、保存时间、文件大小等

## 存档文件说明

### 文件命名规则
- 主存档：`pokemon_save_step0050.pkl` (第50步)
- 备份存档：`pokemon_save_step0040_backup.pkl` (第40步的备份)

### 存档内容
每个存档文件包含：
- 🎮 完整的游戏状态（PyBoy模拟器状态）
- 🧠 AI记忆状态（对话历史或摘要）
- 📊 游戏元数据（步数、时间、版本等）

### 存档管理策略
- 同时只保留一个主存档
- 保存新存档时，旧存档自动变为备份
- 文件名包含累计步数，便于识别进度

## 命令行参数完整列表

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--steps` | int | 10 | 运行步数 |
| `--save-every` | int | 10 | 每N步保存 |
| `--save-dir` | str | "./saves" | 保存目录 |
| `--no-auto-save` | flag | False | 禁用自动保存 |
| `--new-game` | flag | False | 强制新游戏 |
| `--load-backup` | flag | False | 从备份恢复 |
| `--save-info` | flag | False | 显示存档信息 |
| `--load-state` | str | None | 指定存档文件 |

## 使用场景示例

### 场景1：日常游戏
```bash
# 第一次运行
python main.py --steps 50

# 第二次运行（自动继续）
python main.py --steps 30
```

### 场景2：测试新策略
```bash
# 备份当前进度
python main.py --save-info  # 查看当前进度

# 尝试新策略
python main.py --steps 20

# 如果不满意，从备份恢复
python main.py --load-backup --steps 10
```

### 场景3：长时间运行
```bash
# 设置更频繁的保存
python main.py --steps 200 --save-every 5
```

## 日志信息说明

运行时会看到以下类型的日志：

### 保存相关日志
```
🔄 [自动保存] 正在保存游戏进度 (第20步)...
💾 旧存档已备份: pokemon_save_step0010_backup.pkl
✅ 存档保存成功: pokemon_save_step0020.pkl (45.2KB)
🎮 [自动保存] 游戏进度已保存 (累计20步)
```

### 加载相关日志
```
📂 正在加载存档: pokemon_save_step0020.pkl
🎮 正在恢复游戏状态...
🧠 正在恢复AI记忆...
📝 已恢复摘要格式的AI记忆
✅ 存档加载成功！
   📁 文件: pokemon_save_step0020.pkl (45.2KB)
   🕐 保存时间: 2024-01-15T10:30:45
   🎯 累计步数: 20
   🚀 游戏可以继续进行
```

### 异常退出日志
```
🚨 检测到程序异常退出，正在执行紧急保存...
💾 旧存档已备份: pokemon_save_step0020_backup.pkl
✅ 存档保存成功: pokemon_save_step0025.pkl (46.1KB)
🛡️ 紧急保存完成！游戏进度已安全保存 (第25步)
⏹️ 收到键盘中断信号，游戏已安全停止
```

## 故障排除

### 问题1：存档加载失败
```
❌ 加载存档失败: [错误信息]
   存档文件可能已损坏，请尝试使用备份存档
```
**解决方案**：使用 `--load-backup` 参数从备份恢复

### 问题2：保存目录不存在
程序会自动创建保存目录，无需手动创建。

### 问题3：磁盘空间不足
```
❌ [自动保存] 保存失败，游戏将继续运行: [错误信息]
```
**解决方案**：清理磁盘空间或更改保存目录

## 技术细节

### AI记忆连续性
- 保存时会提取当前的AI记忆摘要
- 加载时优先使用摘要格式恢复记忆
- 确保AI能够无缝继续之前的游戏逻辑

### 异常安全性
- 所有保存操作都有完整的错误处理
- 异常退出时自动执行紧急保存
- 紧急保存的格式与正常保存完全相同

### 性能优化
- 存档文件使用pickle格式，加载速度快
- 自动备份机制避免数据丢失
- 文件名包含步数信息，便于管理

## 注意事项

1. **存档兼容性**：新版本的存档格式向后兼容
2. **文件安全**：重要存档建议手动备份到其他位置
3. **磁盘空间**：每个存档约40-50KB，注意磁盘空间
4. **中断处理**：使用Ctrl+C安全退出，会自动保存进度

---

**版本**: v1.0  
**更新时间**: 2024年1月15日